#!/bin/bash
# bk-list-skills
#
# List all Claude skills with their descriptions
# Extracts name and description from YAML frontmatter in SKILL.md files
# Usage: bk-list-skills [--json|--names-only|--full]

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check if BK_HOME is set
if [ -z "$BK_HOME" ]; then
    echo -e "${RED}Error: BK_HOME environment variable is not set.${NC}"
    echo "Please set BK_HOME to the root directory of your claude-skills repository."
    echo "Example: export BK_HOME=$HOME/Documents/ws/claude-skills"
    exit 1
fi

# Check if BK_HOME directory exists
if [ ! -d "$BK_HOME" ]; then
    echo -e "${RED}Error: BK_HOME directory does not exist: $BK_HOME${NC}"
    exit 1
fi

# Skill directory locations
SOURCE_SKILLS_DIR="$BK_HOME/skills"
USER_SKILLS_DIR="$HOME/.claude/skills"
PROJECT_SKILLS_DIR=".claude/skills"

# Check for output mode flags
JSON_OUTPUT=0
NAMES_ONLY=0
FULL_OUTPUT=0

if [ "$1" == "--json" ]; then
    JSON_OUTPUT=1
elif [ "$1" == "--names-only" ]; then
    NAMES_ONLY=1
elif [ "$1" == "--full" ]; then
    FULL_OUTPUT=1
fi

if [ $FULL_OUTPUT -eq 1 ]; then
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}Available Claude Skills${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "BK_HOME: ${YELLOW}$BK_HOME${NC}"
    echo ""
fi

# Array to store skills for JSON output
declare -a SKILLS_JSON=()
# Array to store skill names for names-only output
declare -a SKILLS_NAMES=()
# Array to store "name|||location" pairs for tracking
declare -a SKILLS_WITH_LOCATION=()

# Function to process skills in a directory
process_skills_dir() {
    local skills_dir="$1"
    local location="$2"

    # Check if skills directory exists
    if [ ! -d "$skills_dir" ]; then
        return
    fi

    # Loop through each directory in skills/
    for skill_dir in "$skills_dir"/*; do
        # Skip if not a directory
        if [ ! -d "$skill_dir" ]; then
            continue
        fi

        skill_name=$(basename "$skill_dir")
        skill_md="$skill_dir/SKILL.md"

        # Check if SKILL.md exists
        if [ ! -f "$skill_md" ]; then
            if [ $JSON_OUTPUT -eq 0 ] && [ $NAMES_ONLY -eq 0 ]; then
                echo "âš ï¸  $skill_name: No SKILL.md file found"
                echo ""
            fi
            continue
        fi

        # Extract name and description from YAML frontmatter
        # Read lines between --- markers and extract name and description
        in_frontmatter=0
        name=""
        description=""

        while IFS= read -r line; do
            # Check for YAML frontmatter delimiters
            if [[ "$line" == "---" ]]; then
                if [ $in_frontmatter -eq 0 ]; then
                    in_frontmatter=1
                else
                    # End of frontmatter, stop reading
                    break
                fi
                continue
            fi

            # If we're in frontmatter, extract name and description
            if [ $in_frontmatter -eq 1 ]; then
                if [[ "$line" =~ ^name:\ * ]]; then
                    name=$(echo "$line" | sed 's/^name: *//')
                elif [[ "$line" =~ ^description:\ * ]]; then
                    # Handle multi-line descriptions
                    description=$(echo "$line" | sed 's/^description: *//')
                fi
            fi
        done < "$skill_md"

        # Use skill_name as fallback if name not found
        if [ -z "$name" ]; then
            name="$skill_name"
        fi

        if [ -z "$description" ]; then
            description="(No description found)"
        fi

        # Escape quotes for JSON
        name_escaped=$(echo "$name" | sed 's/"/\\"/g')
        description_escaped=$(echo "$description" | sed 's/"/\\"/g')

        if [ $JSON_OUTPUT -eq 1 ]; then
            # Add to JSON array
            SKILLS_JSON+=("{\"name\":\"$name_escaped\",\"description\":\"$description_escaped\",\"location\":\"$location\"}")
        elif [ $NAMES_ONLY -eq 1 ]; then
            # Add to names array
            SKILLS_NAMES+=("$name")
        elif [ $FULL_OUTPUT -eq 1 ]; then
            # Display the skill information (detailed format)
            echo "ğŸ“˜ Skill: $name ($location)"
            echo "   Description: $description"
            echo ""
        else
            # Default: Store name and location together
            SKILLS_WITH_LOCATION+=("$name|||$location")
        fi
    done
}

# Process source skills directory (from BK_HOME)
process_skills_dir "$SOURCE_SKILLS_DIR" "source"

# Process user skills directory
process_skills_dir "$USER_SKILLS_DIR" "user"

# Check if project skills directory exists
PROJECT_SKILLS_EXISTS=0
if [ -d "$PROJECT_SKILLS_DIR" ]; then
    PROJECT_SKILLS_EXISTS=1
    # Process project skills directory
    process_skills_dir "$PROJECT_SKILLS_DIR" "project"
fi

# For default output, process the SKILLS_WITH_LOCATION array
if [ ${#SKILLS_WITH_LOCATION[@]} -gt 0 ]; then
    # Sort by name (before the |||)
    IFS=$'\n' SORTED_SKILLS=($(printf '%s\n' "${SKILLS_WITH_LOCATION[@]}" | sort))
    unset IFS

    # Build unique skills with combined locations
    declare -a UNIQUE_SKILLS=()
    prev_name=""
    locations=""

    for entry in "${SORTED_SKILLS[@]}"; do
        name="${entry%%|||*}"
        location="${entry##*|||}"

        if [ "$name" != "$prev_name" ]; then
            # New skill name found
            if [ -n "$prev_name" ]; then
                # Save previous skill
                UNIQUE_SKILLS+=("$prev_name|||$locations")
            fi
            prev_name="$name"
            locations="$location"
        else
            # Same skill, append location if not duplicate
            if [[ ! "$locations" =~ $location ]]; then
                locations="$locations, $location"
            fi
        fi
    done

    # Don't forget the last skill
    if [ -n "$prev_name" ]; then
        UNIQUE_SKILLS+=("$prev_name|||$locations")
    fi
fi

# Sort the skills names alphabetically and remove duplicates
IFS=$'\n' SKILLS_NAMES=($(sort -u <<<"${SKILLS_NAMES[*]}"))
unset IFS

# Count total skills from all directories
# Note: Use -type d,l to count both directories and symlinks
source_count=0
user_count=0
project_count=0

if [ -d "$SOURCE_SKILLS_DIR" ]; then
    source_count=$(find "$SOURCE_SKILLS_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) 2>/dev/null | wc -l | tr -d ' ')
fi

if [ -d "$USER_SKILLS_DIR" ]; then
    user_count=$(find "$USER_SKILLS_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) 2>/dev/null | wc -l | tr -d ' ')
fi

if [ -d "$PROJECT_SKILLS_DIR" ]; then
    project_count=$(find "$PROJECT_SKILLS_DIR" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) 2>/dev/null | wc -l | tr -d ' ')
fi

total_count=$((source_count + user_count + project_count))

if [ $JSON_OUTPUT -eq 1 ]; then
    # Output compact JSON format (single line, no pretty printing)
    echo -n "{\"total\":$total_count,\"source\":$source_count,\"user\":$user_count,\"project\":$project_count,\"skills\":["

    # Join array elements with commas
    first=1
    for skill in "${SKILLS_JSON[@]}"; do
        if [ $first -eq 1 ]; then
            first=0
        else
            echo -n ","
        fi
        echo -n "$skill"
    done
    echo "]}"
elif [ $NAMES_ONLY -eq 1 ]; then
    # Output names only (one per line)
    for name in "${SKILLS_NAMES[@]}"; do
        echo "$name"
    done
elif [ $FULL_OUTPUT -eq 1 ]; then
    # Output human-readable format with totals
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}Total skills: $total_count${NC} ${YELLOW}(source: $source_count, user: $user_count, project: $project_count)${NC}"
else
    # Default: Output names one per line with location
    for entry in "${UNIQUE_SKILLS[@]}"; do
        name="${entry%%|||*}"
        location="${entry##*|||}"
        # Replace "user" with "global" in location
        location="${location//user/global}"
        echo "$name ($location)"
    done

    # Add informational message
    echo ""
    echo -e "${BLUE}Skill locations:${NC}"
    echo -e "  ${YELLOW}source${NC}  - Skills from $BK_HOME/skills"
    echo -e "  ${YELLOW}global${NC}  - Installed skills in ~/.claude/skills"
    if [ $PROJECT_SKILLS_EXISTS -eq 1 ]; then
        echo -e "  ${YELLOW}project${NC} - Project-specific skills in .claude/skills"
    fi
    echo ""
    echo -e "${BLUE}Use --full to get detailed descriptions of all skills${NC}"
fi
