#!/bin/bash
#
# bk - Build/Book utilities menu
# Lists all available bk* scripts in $BK_HOME/scripts/
# Usage: bk [number] - runs the corresponding script

# Check if BK_HOME is set
if [ -z "$BK_HOME" ]; then
    echo "Error: BK_HOME environment variable is not set."
    echo "Please set BK_HOME to the root directory of your claude-skills repository."
    echo "Example: export BK_HOME=$HOME/Documents/ws/claude-skills"
    exit 1
fi

# Check if BK_HOME directory exists
if [ ! -d "$BK_HOME" ]; then
    echo "Error: BK_HOME directory does not exist: $BK_HOME"
    exit 1
fi

# Check if scripts directory exists
if [ ! -d "$BK_HOME/scripts" ]; then
    echo "Error: $BK_HOME/scripts directory does not exist"
    exit 1
fi

# Color codes for better visibility
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Function to extract description from a script file
# Looks for a comment line starting with # followed by description text
get_description() {
    local file="$1"
    local desc=""

    # Try to find a description comment (typically on line 3 or 4)
    # Look for lines that start with # followed by text (but not #!)
    desc=$(grep -E "^#[^!]" "$file" | grep -v "^#!/" | grep -v "^#$" | head -1 | sed 's/^# *//')

    # If no description found, use a default
    if [ -z "$desc" ]; then
        desc="No description available"
    fi

    echo "$desc"
}

echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Build/Book Utilities${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
echo -e "BK_HOME: ${YELLOW}$BK_HOME${NC}"
echo ""

# Discover all bk* scripts in $BK_HOME/scripts/
declare -a script_files=()
declare -a script_descriptions=()

# Find all bk* files in scripts directory
shopt -s nullglob
for script in "$BK_HOME"/scripts/bk*; do
    if [ -f "$script" ] && [ -x "$script" ]; then
        script_files+=("$script")
        desc=$(get_description "$script")
        script_descriptions+=("$desc")
    fi
done
shopt -u nullglob

# Check if any scripts were found
if [ ${#script_files[@]} -eq 0 ]; then
    echo -e "${RED}No executable bk* scripts found in $BK_HOME/scripts/${NC}"
    exit 1
fi

# Print the menu
num=1
for i in "${!script_files[@]}"; do
    script_name=$(basename "${script_files[$i]}")
    desc="${script_descriptions[$i]}"
    printf "  ${GREEN}%2s${NC}. %-35s %s\n" "$num" "$script_name" "$desc"
    ((num++))
done

echo ""
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
echo -e "Usage: ${GREEN}bk${NC} - show this menu"
echo -e "       ${GREEN}bk [number]${NC} - run the corresponding script"
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"

# If a number argument is provided, execute that script
if [ $# -eq 1 ]; then
    choice="$1"

    # Validate that choice is a number
    if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
        echo -e "${RED}Error: Invalid choice '$choice'. Please enter a number.${NC}"
        exit 1
    fi

    # Convert to array index (subtract 1)
    index=$((choice - 1))

    # Check if choice is within range
    if [ "$index" -lt 0 ] || [ "$index" -ge "${#script_files[@]}" ]; then
        echo -e "${RED}Error: Invalid choice '$choice'. Please select a number between 1 and ${#script_files[@]}.${NC}"
        exit 1
    fi

    # Execute the selected script
    selected_script="${script_files[$index]}"
    echo -e "${GREEN}Running: $(basename "$selected_script")${NC}"
    echo ""
    exec "$selected_script"
fi
