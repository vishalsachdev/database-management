#!/bin/bash
# bk-install-scripts
#
# Creates symbolic links for all bk* scripts in $BK_HOME/scripts/
# and places them in $HOME/.local/bin for easy command-line access

set -e  # Exit on error

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check if BK_HOME is set
if [ -z "$BK_HOME" ]; then
    echo -e "${RED}Error: BK_HOME environment variable is not set.${NC}"
    echo "Please set BK_HOME to the root directory of your claude-skills repository."
    echo "Example: export BK_HOME=$HOME/Documents/ws/claude-skills"
    exit 1
fi

# Check if BK_HOME directory exists
if [ ! -d "$BK_HOME" ]; then
    echo -e "${RED}Error: BK_HOME directory does not exist: $BK_HOME${NC}"
    exit 1
fi

# Check if scripts directory exists
if [ ! -d "$BK_HOME/scripts" ]; then
    echo -e "${RED}Error: $BK_HOME/scripts directory does not exist${NC}"
    exit 1
fi

SCRIPT_DIR="$BK_HOME/scripts"
TARGET_DIR="$HOME/.local/bin"

echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Installing bk* script symlinks${NC}"
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
echo -e "BK_HOME: ${YELLOW}$BK_HOME${NC}"
echo -e "Target:  ${YELLOW}$TARGET_DIR${NC}"
echo ""

# Create target directory if it doesn't exist
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${GREEN}Creating directory: $TARGET_DIR${NC}"
    mkdir -p "$TARGET_DIR"
fi

# Counter for installed scripts
installed_count=0
declare -a installed_links=()

# Find all bk* scripts in $BK_HOME/scripts/
shopt -s nullglob
for script in "$SCRIPT_DIR"/bk*; do
    # Skip if not a file or not executable
    if [ ! -f "$script" ] || [ ! -x "$script" ]; then
        continue
    fi

    # Get the base name
    script_name=$(basename "$script")

    # Create link path
    link_path="$TARGET_DIR/$script_name"

    # Remove existing file or symlink if it exists
    if [ -e "$link_path" ] || [ -L "$link_path" ]; then
        rm -f "$link_path"
    fi

    # Create symlink
    ln -s "$script" "$link_path"
    echo -e "${GREEN}✓${NC} $script_name -> $script"
    installed_links+=("$script_name")
    ((installed_count++))
done
shopt -u nullglob

echo ""
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"

# Check if any scripts were installed
if [ "$installed_count" -eq 0 ]; then
    echo -e "${YELLOW}No executable bk* scripts found in $BK_HOME/scripts/${NC}"
    exit 0
fi

echo -e "${GREEN}Successfully installed $installed_count bk* script link(s) to $TARGET_DIR${NC}"
echo ""

# List the installed links
echo -e "${BLUE}Installed book utility links:${NC}"
for link in "${installed_links[@]}"; do
    echo -e "  - ${GREEN}$link${NC}"
done

echo ""
echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"

# Check if $HOME/.local/bin is in PATH
if [[ ":$PATH:" == *":$TARGET_DIR:"* ]]; then
    echo -e "${GREEN}✓${NC} $TARGET_DIR is already in your PATH"
    echo -e "${GREEN}✓${NC} You can now use these commands from anywhere"
else
    echo -e "${YELLOW}⚠${NC}  $TARGET_DIR is NOT in your PATH"
    echo ""
    echo "To use these scripts, add the following line to your shell startup file:"
    echo ""

    # Detect shell and provide appropriate instructions
    CURRENT_SHELL=$(basename "$SHELL")

    case "$CURRENT_SHELL" in
        bash)
            echo -e "${BLUE}# For Bash (add to ~/.bashrc or ~/.bash_profile):${NC}"
            echo 'export PATH="$HOME/.local/bin:$PATH"'
            ;;
        zsh)
            echo -e "${BLUE}# For Zsh (add to ~/.zshrc):${NC}"
            echo 'export PATH="$HOME/.local/bin:$PATH"'
            ;;
        fish)
            echo -e "${BLUE}# For Fish (add to ~/.config/fish/config.fish):${NC}"
            echo 'set -gx PATH $HOME/.local/bin $PATH'
            ;;
        *)
            echo -e "${BLUE}# Add to your shell startup file:${NC}"
            echo 'export PATH="$HOME/.local/bin:$PATH"'
            ;;
    esac

    echo ""
    echo "After adding the line, run:"
    echo "  source ~/.${CURRENT_SHELL}rc    # Or restart your terminal"
fi

echo -e "${BLUE}════════════════════════════════════════════════════════════════${NC}"
